# Stream Simulator: {{ node_id }}
# Profile: {{ data_profile }}

from pyspark.sql import functions as F

df_{{ node_id | pyvar }} = (
    spark.readStream
    .format("rate")
    .option("rowsPerSecond", {{ events_per_second }})
{% if num_partitions %}
    .option("numPartitions", {{ num_partitions }})
{% endif %}
    .load()
)

{% if data_profile == 'iot-sensors' %}
df_{{ node_id | pyvar }} = df_{{ node_id | pyvar }}.select(
    (F.col("value") % 100).alias("sensor_id"),
    F.concat(F.lit("sensor-"), (F.col("value") % 100).cast("string")).alias("device_id"),
    (F.lit(-10.0) + F.rand() * 60.0).alias("temperature"),
    (F.lit(10.0) + F.rand() * 90.0).alias("humidity"),
    F.col("timestamp").alias("event_time"),
)
{% elif data_profile == 'clickstream' %}
df_{{ node_id | pyvar }} = df_{{ node_id | pyvar }}.select(
    F.concat(F.lit("user-"), (F.col("value") % 1000).cast("string")).alias("user_id"),
    F.concat(F.lit("session-"), (F.col("value") % 500).cast("string")).alias("session_id"),
    F.when((F.col("value") % 5) == 0, "page_view")
     .when((F.col("value") % 5) == 1, "click")
     .when((F.col("value") % 5) == 2, "scroll")
     .when((F.col("value") % 5) == 3, "add_to_cart")
     .otherwise("purchase").alias("event_type"),
    F.concat(F.lit("/page/"), (F.col("value") % 50).cast("string")).alias("page_url"),
    F.col("timestamp").alias("event_time"),
)
{% elif data_profile == 'financial-transactions' %}
df_{{ node_id | pyvar }} = df_{{ node_id | pyvar }}.select(
    F.concat(F.lit("txn-"), F.col("value").cast("string")).alias("transaction_id"),
    F.concat(F.lit("acct-"), (F.col("value") % 200).cast("string")).alias("account_id"),
    F.round(F.rand() * 5000.0, 2).alias("amount"),
    F.when((F.col("value") % 4) == 0, "USD")
     .when((F.col("value") % 4) == 1, "EUR")
     .when((F.col("value") % 4) == 2, "GBP")
     .otherwise("JPY").alias("currency"),
    F.when((F.col("value") % 3) == 0, "debit")
     .when((F.col("value") % 3) == 1, "credit")
     .otherwise("transfer").alias("txn_type"),
    F.col("timestamp").alias("event_time"),
)
{% elif data_profile == 'ecommerce-orders' %}
df_{{ node_id | pyvar }} = df_{{ node_id | pyvar }}.select(
    F.concat(F.lit("order-"), F.col("value").cast("string")).alias("order_id"),
    F.concat(F.lit("cust-"), (F.col("value") % 500).cast("string")).alias("customer_id"),
    F.concat(F.lit("prod-"), (F.col("value") % 100).cast("string")).alias("product_id"),
    (1 + (F.col("value") % 10)).cast("int").alias("quantity"),
    F.round(F.rand() * 200.0, 2).alias("unit_price"),
    F.when((F.col("value") % 3) == 0, "pending")
     .when((F.col("value") % 3) == 1, "shipped")
     .otherwise("delivered").alias("status"),
    F.col("timestamp").alias("event_time"),
)
{% endif %}
